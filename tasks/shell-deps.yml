---
# Install things that shells are configured to need for aliases, etc.

- name: Install various CLI/shell deps on macOS
  when: ansible_os_family == 'Darwin'
  homebrew:
    state: present
    name:
      - grc
      - direnv
      - bat
      - fd
      - ag
      - exa
      - fzf
      - colordiff

- name: Install various CLI/shell deps on Debian-family
  become: true
  when: ansible_os_family == 'Debian'
  apt:
    state: present
    name:
      # TODO: bat
      - grc
      - direnv
      - fd-find
      - silversearcher-ag
      - fzf
      - colordiff

- name: Install exa on Debian or Ubuntu >= 20.10
  become: true
  when: ansible_os_family == 'Debian' and (ansible_distribution != 'Ubuntu' or ansible_distribution_version is version('20.10', '>='))
  apt:
    state: present
    name: exa

- name: Check for exa to short-circuit build on older Ubuntu
  stat:
    path: /usr/local/bin/exa
  when:
    - ansible_distribution == 'Ubuntu'
    - ansible_distribution_version is version('20.10', '<')
  register: _exa_stat

- name: Install exa by compiling on older Ubuntu
  when:
    - ansible_distribution == 'Ubuntu'
    - ansible_distribution_version is version('20.10', '<')
    - not _exa_stat.stat.exists
  vars:
    _exa_version: 0.10.1
  block:
    - name: Install build deps
      become: true
      apt:
        name: [libgit2-dev, rustc]
        state: present

    - name: Clone exa
      git:
        repo: https://github.com/ogham/exa
        dest: "{{ home_dir }}/devel/contrib/exa"
        depth: 1
        version: v{{ _exa_version }}

    - name: Build exa
      command: cargo build --release
      args:
        chdir: "{{ home_dir }}/devel/contrib/exa"
        creates: "{{ home_dir }}/devel/contrib/exa/target/release/exa"

    - name: Install exa
      become: true
      command: install target/release/exa /usr/local/bin/exa
      args:
        chdir: "{{ home_dir }}/devel/contrib/exa"
        creates: "/usr/local/bin/exa"
